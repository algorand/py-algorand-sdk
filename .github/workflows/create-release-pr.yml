name: Create Release PR

on:
  workflow_dispatch:
    inputs:
      source_ref:
        description: 'Source branch, commit, or tag to create the release branch from'
        default: 'develop'
        type: string
      release_version:
        description: 'In the vX.X.X format and will be used for tag and branch name'
        default: 'vx.x.x'
        required: true
        type: string

env:
  RELEASE_VERSION: ${{ inputs.release_version }}
  SOURCE_REF: ${{ inputs.source_ref }}

jobs:
  create-release-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.source_ref }}

      - name: Create Release Branch
        id: create-release-branch
        run: |
          if [[ $RELEASE_VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            git checkout -b release/$RELEASE_VERSION
            git push --set-upstream origin release/$RELEASE_VERSION
          else
            echo "Version input doesn't match the regex pattern ^v[0-9]+\.[0-9]+\.[0-9]+$"
            exit 1
          fi
          echo "release-version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "release-branch=release/$RELEASE_VERSION" >> $GITHUB_OUTPUT

      - name: Get Latest Release
        id: get-release
        run: |
          releases=$(curl --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                      --header "Accept: application/vnd.github.v3+json" \
                      "https://api.github.com/repos/${{ github.repository }}/releases")
          tag=$(echo "$releases" | jq -r '.[0].tag_name')
          echo "latest-tag=$tag" >> $GITHUB_OUTPUT

      - name: Build Changelog
        uses: mikepenz/release-changelog-builder-action@v3.7.2
        id: build-changelog
        env:
          PREVIOUS_VERSION: ${{ steps.get-release.outputs.latest-tag }}
        with:
          fromTag: ${{ env.PREVIOUS_VERSION }}
          toTag: ${{ steps.create-release-branch.outputs.release-branch }}
          ignorePreReleases: true
          failOnError: true
          configurationJson: |
            {
                "categories": [
                    {
                        "title": "## New Features",
                        "labels": [
                            "New Feature"
                        ]
                    },
                    {
                        "title": "## Enhancement",
                        "labels": [
                            "Enhancement"
                        ]
                    },
                    {
                        "title": "## Bug Fixes",
                        "labels": [
                            "Bug-Fix"
                        ]
                    },
                    {
                        "title": "## Not Yet Enabled",
                        "labels": [
                            "Not-Yet-Enabled"
                        ]
                    }
                ],
                "ignore_labels": [
                    "Skip-Release-Notes"
                ],
                "sort": {
                    "order": "ASC",
                    "on_property": "mergedAt"
                },
                "template": "#{{CHANGELOG}}",
                "pr_template": "- #{{TITLE}} by #{{AUTHOR}} in ##{{NUMBER}}"
            }

      - name: Update Changelog
        id: update-changelog
        env:
          CHANGELOG_CONTENT: ${{ steps.build-changelog.outputs.changelog }}
          PREVIOUS_VERSION: ${{ steps.get-release.outputs.latest-tag }}
        run: |
          git branch --show-current
          echo "$(tail -n +2 CHANGELOG.md)" > CHANGELOG.md
          UPDATED_CHANGELOG="${CHANGELOG_CONTENT}**Full Changelog**: https://github.com/algorand/py-algorand-sdk/compare/${PREVIOUS_VERSION}...${RELEASE_VERSION}"
          echo "updated-changelog=$UPDATED_CHANGELOG" >> $GITHUB_OUTPUT
          echo -e "# Changelog\n\n# ${RELEASE_VERSION}\n\n${UPDATED_CHANGELOG}" | cat - CHANGELOG.md > temp && mv temp CHANGELOG.md

      - name: Commit Changes
        uses: EndBug/add-and-commit@v9.1.3
        with:
          message: 'update CHANGELOG.md'

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5.0.1
        with:
          branch: release/$RELEASE_VERSION
          base: master
          title: "FOR REVIEW ONLY: py-algorand-sdk $RELEASE_VERSION"
          body: "${{ steps.update-changelog.outputs.updated-changelog }}"
          assignees: algobarb
          team-reviewers: algorand/devops
          draft: true
          labels: "Skip-Release-Notes"
